# functions.sh: LCARS theme on Linux DE for LCARchS.

# VERSION: 01-g3mx-alpha: GTK, GDM, Gnome, Metacity, Xfce4
# AUTHOR: Joseph Edwards <github.com:joseph8th/lcars_gx.git>

# Settings in 'lcars.conf' file:

#### Helper functions ####

# usage function for getopts() 
usage() 
{
cat << EOF

USAGE: $0 options [elements]

DESCRIPTION: LCARchS is a Star Trek fan LCARS desktop theme utility for Linux.
This version (gx02) optimized for Arch Linux with Xfce4/GTK and GDM splashpage. 

OPTIONS (choose one):
  -h  Show this message
  -i  Install a theme element
  -r  Remove a theme element

MODIFIERS (optional):
  -x  Choose DE/WM
  -a  Activate after install

ENVIRONMENT (DE/WM) flags (optional):
  xfce  Xfce4
  g2    GNOME2
  meta  Metacity (Nautilus)
  (*)   Default: "xfce"

ELEMENTS:
  all    All elements 
  dbg    Desktop background
  gdm    GDM splash screen
  theme  GTK theme
  sound  Alert sound
  conky  Conky configs

NOTES:
  * Quote multiple elements or enviornments.
  * Expect root access password request.

EXAMPLES:

* Install and attempt to activate background and gdm themes
  for Xfce4 and GNOME2:

  $ lcarchs -i "dbg gdm" -x "xfce g2" -a

* Remove and restore (activate removal) of conky config:

  $ lcarchs -r conky -a
EOF
}


# Sudo mkdir used if dir structure is new
_mk_dir()
{
    printf "Really mkdir %s ? (y/n): " "$1"
    read ans
    [ $ans == "y" ] && mkdir "$1" && return 0 || return 1
}


# Sudo mkdir used if dir structure is new
_smk_dir()
{
    printf "Really sudo mkdir %s ? (y/n): " "$1"
    read ans
    [ $ans == "y" ] && sudo mkdir "$1" && return 0 || return 1
}



# Function to check if array contains element
contains_elt() {
    for e in "${@:2}"; do [[ "$e" == "$1" ]] && return 0; done
    return 1
}


#### GLOBAL VARIABLES ####

ELTLIST=( dbg gdm theme sound conky )
XLIST=( xfce g2 meta )


# Function to update .config/$LCARS directories
_updateconf() {

    local workdir=$LCARS_HOME
    declare -a local pkg=( )

    echo "Updating your $LCARS config files..."
    case "$1" in
        dbg)
            workdir=${workdir}${MY_BGS}
            [ ! -f  "${workdir}/${LCARS_BG}" ] && pkg=("$PKG_BG")
            ;;
        gdm)
            workdir=${workdir}${MY_BGS}
            [ ! -f  "${workdir}/${LCARS_LOGIN_BG}" ] && pkg=("$PKG_LOGIN_BG")
            ;;
        theme)
            workdir=${workdir}${MY_THEMES}
            [ ! -f "${workdir}/${LCARS_THEME}" ] && pkg=("$PKG_THEME")
            if $(contains_elt  "meta" "$MY_XENV"); then
                if [ ! -f "${workdir}/${LCARS_METACITY}" ]; then 
                    pkg=("${pkg[@]}" "$PKG_METACITY")
                fi
            fi
            ;;
        sound)
            workdir=${LCARS_HOME}${MY_SOUNDS}
            [ ! -f "${workdir}/${LCARS_THEME}" ] && pkg=("$PKG_SOUND")
            ;;
        conky)
            workdir=${LCARS_CONFD}
            [ ! -f "${workdir}/${LCARS_CONKY}" ] && pkg=("$PKG_CONKY")
            ;;
    esac

    for p in "${pkg[@]}"
    do
        printf "==> Copying:\t%s\n\t-->\t%s\n" "$p" "$workdir"
#        cp $pkg $workdir
    done
}



#### Remove function ####
lcars_remove() 
{
    for elt in "${MY_ELEMENTS[@]}"
    do
        echo "==> Removing ${elt} for ${x}..."
    done
}

lcars_restore()
{
    for elt in "${MY_ELEMENTS[@]}"
    do
        echo "==> Attempting to restore ${elt}..."
    done
}


### Install function ###
lcars_install() 
{
    for elt in "${MY_ELEMENTS[@]}"
    do
        echo "==> Installing ${elt}..."
#        _install $elt
    done
}

lcars_activate()
{
    for elt in "${MY_ELEMENTS[@]}"
    do
        echo "==> Attempting to activate ${elt}..."
    done
}


# Install config'd files to LCARS_SHARE 
# + link to MY_SHARE sibling dirs
_install()
{
    # Update configurable files folders for given $elt
    _updateconf $1

    case "$1" in
        dbg)
            # Background install 
            work_dir=${MY_SHARE}${MY_BGS}
            if [ ! -d "${work_dir}/${LCARS}" ]; then
	        echo "LCARS backgrounds not installed..."
                echo "==> Creating: ${workdir}/${LCARS}"
	        _smk_dir ${work_dir}/${LCARS}
            fi
            # Copy config'd files to usr/share
            echo "==> Copying: ${LCARS_SHARE}${MY_BGS}"
	    sudo cp ${LCARS_SHARE}${MY_BGS}/* ${work_dir}/${LCARS}/
#### Enable for Linux Mint
#            ln -sf ${work_dir}/${LCARS}/${LCARS_BG} ${work_dir}${MY_DEFAULT_BG}
            ;;
    esac
    `
    # Install LCARS defaultsound.wav as login sound
    if [ "$1" = "sound" ]; then
        work_dir=${MY_USR_SHARE_DIR}${MY_SOUNDS_DIR}
        if [ ! -d "$work_dir/lcars_gx" ]; then
            echo "LCARS sounds not installed... attempting installation."
            mkdir $work_dir/lcars_gx
        fi
        if [ -d "$work_dir/lcars_gx" ]; then
            cp ./sounds/* $work_dir/lcars_gx/
            ln -sf ${work_dir}/lcars_gx/${LCARS_LOGIN_SOUND} ${work_dir}${MY_DEFAULT_SOUND}
        fi
    fi

    # Install LCARS-GTK-2.0 desktop theme
    if [ "$1" = "gtk" ]; then
        work_dir=${MY_USR_SHARE_DIR}${MY_GTK_THEMES_DIR}
        if [ ! -d "$work_dir/LCARS-GTK" ]; then
            echo "LCARS-GTK desktop theme not installed... attempting installation."
            echo "Activate the theme in Appearance settings."
            printf "Extracting %s to %s%s.\n" $LCARS_GTK_THEME $MY_USR_SHARE_DIR $MY_GTK_THEMES_DIR
            tar -zxvf ./themes/${LCARS_GTK_THEME} -C $work_dir
            chmod 755 $work_dir/LCARS-GTK/gtk-2.0/gtkrc
        else
            echo "LCARS-GTK theme already installed."
        fi
    fi

    # Install LCARS-Desktop Gnome's Nautilus/Metacity window mngr theme
    if [ "$1" = "gnome" ]; then
        work_dir=${MY_USR_SHARE_DIR}${MY_GTK_THEMES_DIR}
        if [ ! -d "$work_dir/LCARS-Desktop" ]; then
            echo "LCARS-Desktop windows theme not installed... attempting installation."
            echo "Activate the theme in Window decoration settings."
            printf "Extracting %s to %s%s.\n" $LCARS_GTK_THEME $MY_USR_SHARE_DIR $MY_GTK_THEMES_DIR
            tar -zxvf ./themes/${LCARS_METACITY} -C $work_dir
            chmod 755 $work_dir/LCARS-Desktop/index.theme
        else
            echo "LCARS-Desktop theme already installed."
        fi
    fi

    # Setup and configure Conky for LCARS-GX.
    if [ "$1" = "conky" ]; then
        if [ -f $MY_HOME/.conkyrc ]; then
            echo "You must mv your old '~/.conkyrc' to a new name before installing."
        else
            echo "No ~/.conkyrc found. Installing new Conky configuration file."
            printf "Any LCARS-GX specific files will be overwritten if they exist.\n"
            cp ./settings/conkyrc $MY_HOME/.conkyrc

            if [ ! -d ${LCARS_HOME} ]; then
                echo "No ${LCARS_HOME} found. mkdir-ing new LCARS-GX config folder."
                mkdir $LCARS_HOME
            fi
            echo "Installing ${LCARS_HOME}/.conkyrc_logs. Changing permissions!"
            printf "Customize the LOGS settings in this file to suit your system.\n"
            cp ./settings/conkyrc_logs ${LCARS_HOME}/.conkyrc_logs
            chmod 755 /var/log/messages

            if [ ! -d ${LCARS_SHARE} ]; then
                printf "No ${LCARS_SHARE} found. mkdir-ing new startup script folder."
                mkdir $LCARS_SHARE
            fi
            echo "Installing ${LCARS_SHARE}/conky_delay_start script."
            echo "Add this to your Startup settings to activate on startup."
            cp ./scripts/conky_delay_start ${LCARS_SHARE}/
            cp ./lcarsrc.sh ${LCARS_SHARE}/lcarsrc
            chmod 755 ${LCARS_SHARE}/conky_delay_start
            chmod 755 ${LCARS_SHARE}/lcarsrc
            echo "Activating!"
            source ${LCARS_SHARE}/conky_delay_start
        fi
    fi
}
